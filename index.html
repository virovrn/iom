<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Индивидуальный маршрут</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --cream: #F5F9FF;
      --light-blue: #E6F0FF;
      --soft-blue: #C4D8F2;
      --medium-blue: #7AA3CC;
      --dark-blue: #4A6B8A;
      --accent-blue: #5B8AC7;
    }
    body {
      font-family: 'Montserrat', sans-serif;
      background-color: var(--cream);
      color: #4A5568;
      margin: 0;
      padding: 0;
    }
    .container { max-width: 1200px; margin: auto; padding: 20px; }
    .main-title {
      font-family: 'Playfair Display', serif;
      color: var(--dark-blue);
      text-align: center;
      font-size: 2.2rem;
      margin-bottom: 30px;
    }
    #id-form {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(106,142,180,0.08);
      max-width: 500px;
      margin: 0 auto 30px;
      display: flex; flex-direction: column; align-items: center;
    }
    #user-id {
      padding: 12px 15px;
      border: 2px solid var(--medium-blue);
      border-radius: 8px;
      font-size: 16px;
      width: 200px;
      margin-bottom: 15px;
      background: var(--cream);
    }
    #user-id:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(91, 138, 199, 0.2);
    }
    button, .download-btn {
      background: var(--accent-blue);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover, .download-btn:hover { background: var(--dark-blue); }
    .section {
      background: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 5px 15px rgba(106, 142, 180, 0.05);
    }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td {
      padding: 15px; text-align: left;
      border-bottom: 1px solid var(--light-blue);
    }
    th {
      background: var(--light-blue);
      color: var(--dark-blue);
      font-weight: 500;
    }
    tr:nth-child(even) { background: rgba(230,240,255,0.3); }
    tr:hover { background: rgba(196,216,242,0.2); }
    .no-data { text-align: center; font-style: italic; font-size: 1.1rem; }
    footer {
      text-align: center; padding: 30px;
      border-top: 1px solid var(--light-blue);
      color: var(--dark-blue);
    }
    footer a { color: var(--accent-blue); text-decoration: none; }
    footer a:hover { text-decoration: underline; }
    @media (max-width: 768px) {
      .main-title { font-size: 1.8rem; }
      #user-id { width: 100%; }
      .section, #id-form { padding: 20px; }
      th, td { padding: 10px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="main-title">Индивидуальный образовательный маршрут</h1>
    <form id="id-form">
      <label for="user-id">Введите ваш ID:</label>
      <input type="text" id="user-id" name="user-id" placeholder="например, 36251200" />
      <button type="submit">Показать маршрут</button>
    </form>
    <div id="content"></div>
  </div>
  <footer>
    Если вы заметили ошибку, напишите нам на <a href="mailto:nai@virovrn.ru">nai@virovrn.ru</a>
    <br><button id="pdf-download-btn" class="download-btn">Скачать бланк ИОМ в PDF</button>
  </footer>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
  const csvUrls = {
    info: '...csv',
    recom: '...csv',
    tut: '...csv',
    met: '...csv',
    feedback: '...csv',
    active: '...csv'
  };

  const sectionLinks = {
    info: '...',
    recom: '...',
    tut: '...',
    met: '...',
    feedback: '...',
    active: '...'
  };

  async function loadUserData(userId) {
    const content = document.getElementById('content');
    content.innerHTML = '<p style="text-align: center;">Загрузка данных...</p>';
    try {
      const [info, recom, tut, met, feedback, active] = await Promise.all([
        loadCsv(csvUrls.info), loadCsv(csvUrls.recom), loadCsv(csvUrls.tut),
        loadCsv(csvUrls.met), loadCsv(csvUrls.feedback), loadCsv(csvUrls.active)
      ]);

      const idField = Object.keys(info[0])[0];
      const userInfo = info.find(row => row[idField] === userId);
      if (!userInfo) {
        content.innerHTML = '<p class="no-data">Пользователь с таким ID не найден</p>';
        return;
      }

      const fio = userInfo[idField].trim();
      const filtered = {
        recom: filterByFio(recom, fio),
        tut: filterByFio(tut, fio),
        met: filterByFio(met, fio),
        feedback: filterByFio(feedback, fio),
        active: filterByFio(active, fio)
      };

      displayUserData(userInfo, filtered, { recom, tut, met, feedback, active });

    } catch (e) {
      content.innerHTML = `<div class="section"><p class="no-data">Ошибка загрузки: ${e.message}</p></div>`;
    }
  }

  async function loadCsv(url) {
    const res = await fetch(url);
    const text = await res.text();
    return new Promise(resolve => {
      Papa.parse(text, {
        header: true,
        skipEmptyLines: true,
        complete: results => resolve(results.data)
      });
    });
  }

  function filterByFio(data, fio) {
    const fioField = Object.keys(data[0])[0]; // первый столбец — ФИО
    return data.filter(row => row[fioField]?.trim() === fio);
  }

  function getColumns(data, start, end) {
    return Object.keys(data[0]).slice(start, end);
  }
    function displayUserData(info, filtered, all) {
    const content = document.getElementById('content');
    const fioField = Object.keys(info)[1];
    content.innerHTML = `
      ${createInfo(info)}
      ${createSection('Рекомендуемые мероприятия', filtered.recom, getColumns(all.recom, 2, 6), sectionLinks.recom)}
      ${createSection('Тьюторское сопровождение', filtered.tut, getColumns(all.tut, 2, 7), sectionLinks.tut)}
      ${createSection('Методическое сопровождение', filtered.met, getColumns(all.met, 2, 7), sectionLinks.met)}
      ${createSection('Обратная связь', filtered.feedback, getColumns(all.feedback, 2, 7), sectionLinks.feedback)}
      ${createSection('Активность', filtered.active, getColumns(all.active, 2, 5), sectionLinks.active)}
    `;
  }

  function createInfo(userInfo) {
    const rows = Object.entries(userInfo).slice(0, 15).map(([k,v]) =>
      `<tr><th>${k}</th><td>${v || ''}</td></tr>`).join('');
    return `
      <div class="section">
        <h2 class="section-title">Общая информация</h2>
        <em>Изменить — <a href="${sectionLinks.info}" class="section-link">ссылка</a></em>
        <table><tbody>${rows}</tbody></table>
      </div>
    `;
  }

  function createSection(title, data, columns, link) {
    if (!data || data.length === 0) {
      return `<div class="section"><h2 class="section-title">${title}</h2>
        <p class="no-data">Нет данных для отображения</p>
        <em>Добавить — <a href="${link}" class="section-link">ссылка</a></em></div>`;
    }
    const headers = columns.map(c => `<th>${c}</th>`).join('');
    const rows = data.map(row =>
      `<tr>${columns.map(c => `<td>${row[c] || ''}</td>`).join('')}</tr>`).join('');
    return `<div class="section"><h2 class="section-title">${title}</h2>
      <table><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table></div>`;
  }

  function generatePDF() {
    const element = document.getElementById('content');
    if (!element || !element.innerHTML.trim()) {
      alert('Сначала загрузите данные маршрута'); return;
    }
    const clone = element.cloneNode(true);
    clone.querySelectorAll('button, .download-btn, .section-link').forEach(el => el.style.display = 'none');
    document.body.appendChild(clone);

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

    html2canvas(clone, { scale: 2 }).then(canvas => {
      const imgData = canvas.toDataURL('image/jpeg', 0.98);
      const imgWidth = 190;
      const pageHeight = 297;
      const imgHeight = canvas.height * imgWidth / canvas.width;
      let heightLeft = imgHeight;
      let position = 10;
      doc.addImage(imgData, 'JPEG', 10, position, imgWidth, imgHeight);
      heightLeft -= pageHeight - 20;
      while (heightLeft > 0) {
        position = heightLeft - imgHeight + 10;
        doc.addPage();
        doc.addImage(imgData, 'JPEG', 10, position, imgWidth, imgHeight);
        heightLeft -= pageHeight - 20;
      }
      doc.save('ИОМ.pdf');
      document.body.removeChild(clone);
    });
  }

  document.getElementById('id-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const userId = document.getElementById('user-id').value.trim();
    if (userId) loadUserData(userId);
  });

  document.getElementById('pdf-download-btn').addEventListener('click', generatePDF);
</script>
</body>
</html>


